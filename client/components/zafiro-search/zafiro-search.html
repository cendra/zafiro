
<link rel="import" href="../../bower_components/core-icon/core-icon.html">
<link rel="import" href="../../bower_components/core-icons/core-icons.html">
<link rel="import" href="../../bower_components/core-field/core-field.html">
<link rel="import" href="../../bower_components/core-collapse/core-collapse.html">
<link rel="import" href="../../bower_components/core-animation/core-animation.html">
<link rel="import" href="../zafiro-base/zafiro-base.html">
<link rel="import" href="../zafiro-form/zafiro-form.html">

<polymer-element name="zafiro-search" extends="zafiro-base" attributes="zfConfig zfSearch placeholder">
  <template>
  	<style type="text/css">
  		:host {
  			color: black;
        padding: 0px;
  		}
  		core-field {
  			background-color: white;
  			min-width: 400px
  		}
  		core-collapse {
  			background-color: white;
  			border: 1px solid rgba(0, 0, 0, 0.5);
  			position: absolute;
  			top: 0px;
  			min-width: 400px;
  			right: 0px;
  			left: 0px;
        padding: 10px;
  		}
      col-container {
        width: 100%;
      }

  		.hidden {
  			display: none;
  		}
  	</style>
  	<core-field>
  		<core-icon icon="search"></core-icon>
	    <input id="buscar" type="text" placeholder="{{placeholder}}" value="{{searchValue}}" flex/>
	    <core-icon id="colIcon" on-click="{{colToggle}}" icon="arrow-drop-down">
        <core-animation id="rotateCW" target="{{$.colIcon}}" duration="300">
          <core-animation-keyframe>
            <core-animation-prop name="transform" value="rotate(0deg)"/>
          </core-animation-keyframe>
          <core-animation-keyframe>
            <core-animation-prop name="transform" value="rotate(180deg)"/>
          </core-animation-keyframe>
        </core-animation>
        <core-animation id="rotateCCW" target="{{$.colIcon}}" duration="300">
          <core-animation-keyframe>
            <core-animation-prop name="transform" value="rotate(0deg)"/>
          </core-animation-keyframe>
          <core-animation-keyframe>
            <core-animation-prop name="transform" value="rotate(-180deg)"/>
          </core-animation-keyframe>
        </core-animation>
      </core-icon>
	</core-field>
	<div class="col-container" relative>
		<core-collapse id="collapse">
	    	<zafiro-form zfConfig="{{zfConfig}}" ngmodel="{{zs_.origValues.ngModel}}"></zafiro-form>
		</core-collapse>
	</div>
  </template>
  <script>
    var debounce = function(delay) {
      this.t;
      this.debouncing = false;
      var self = this;
      return function(cb) {
        self.debouncing = true;
        if(self.t) clearTimeout(self.t);
        self.t = setTimeout(function() {
          self.debouncing = false;
          cb();
        }, delay);
      };
    };

  	Polymer({
  		scoped: function() {
        var self = this;
        this.debouncedKeyup = new debounce(300);
  			this.$.buscar.addEventListener('keyup', function(event) {
          if(event.keyCode == 13) {
            if(self.debouncedKeyup.debouncing) {
              this.fireSearch = true;
            }
            self.fireSearch();
          } else {
            var input = this;
            self.debouncedKeyup(function(){
              var keys = Object.keys(self.ngModel);
              keys.splice(keys.indexOf('allFields'), 1);
              var reg = new RegExp("(?:^|\\W)(?:("+keys.join('|')+"):)(\\s*(?:\\([^)]+\\)|\\[[^\\]]+\\]|\"[^\"]+\"|'[^']+'|\\S+))(.*)");
              //var reg = new RegExp("(?:("+keys.join('|')+"):)\\s*(\\([^)]+\\))*");
              var allFieldsText = [];
              var text = input.value.trim();
              var m;
              while(m = text.match(reg)) {
                if(!new RegExp("^"+m[1]+':').test(text)) {
                  allFieldsText.push(text.split(m[1]+':')[0]);
                }
                self.ngModel[m[1]] = m[2];
                text = m[3].trim();
              }
              if(text.length) allFieldsText.push(text);
              self.ngModel['allFields'] = allFieldsText.join(' ');
              if(input.fireSearch) {
                input.fireSearch = false;
                self.fireSearch();
              }
            });
            
            /*var m = this.value.match(reg);
            if(m) {

            }*/
          }
        });
  		},
      zfScopeChanged: function(change, path) {
       //this.searchValue = '';
        /*var srchParts = [this.ngModel.allFields];
        for(var i in this.ngModel) {
          if(i=='allFields'||!this.ngModel[i].length) continue;
          srchParts.push(i+':'+this.ngModel[i]);
        }
        this.searchValue = srchParts.join(' ');*/
      },
  		colToggle: function () {
        //Toggle dropdown
        if(this.$.collapse.opened) {
          this.$.rotateCCW.play();
        } else {
          this.$.rotateCW.play();
        }
  			this.$.collapse.toggle();
  		},
  		created: function() {
  			this.super();
        this.placeholder="Search";
  			//this.zs_.add({'zafiro:search:done': 'zfSearch'});
  		},
  		ready: function() {
        //call zafiro-base ready method
  			this.super();

        this.zfConfigChanged();

        //Animation for dropdown icon
        var self = this;
        this.$.rotateCCW.addEventListener('core-animation-finish', function() {
          self.$.colIcon.icon = 'arrow-drop-down';
        });
        this.$.rotateCW.addEventListener('core-animation-finish', function() {
          self.$.colIcon.icon = 'arrow-drop-up';
        });
  		},
      zfConfigChanged: function() {
        //Hide dropdown if no configuration was found
        if(!this.zfConfig) {
          this.$.colIcon.className = 'hidden';
        } else {
          this.$.colIcon.className = '';
        }
      },
  		fireSearch: function() {
  			this.fire('zafiro:search:done')
  		}
  	});
  </script>
</polymer-element>